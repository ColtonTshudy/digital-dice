#include "my_ft6336.h"
#include "ts.h"

/* External I2C handle (generated by STM32CubeMX) */
extern I2C_HandleTypeDef hi2c2;

/* Private function prototypes */
static void FT6336_I2C_Write(uint8_t Addr, uint8_t Reg, uint8_t Value);
static uint8_t FT6336_I2C_Read(uint8_t Addr, uint8_t Reg);
static void FT6336_I2C_ReadMultiple(uint8_t Addr, uint8_t Reg, uint8_t *Buffer, uint16_t Length);

/* FT6336 Driver Structure */
TS_DrvTypeDef ft6336_ts_drv =
{
  ft6336_Init,
  ft6336_ReadID,
  ft6336_Reset,
  ft6336_Start,
  ft6336_DetectTouch,
  ft6336_GetXY,
  ft6336_EnableIT,
  ft6336_ClearIT,
  ft6336_GetITStatus,
  ft6336_DisableIT,
};

int32_t ts_cindex[] = {1024, 1024, 0, 0, 0, 1024, 0};

TS_DrvTypeDef *ts_drv = &ft6336_ts_drv;

/**
  * @brief  Write a value to a register via I2C
  */
static void FT6336_I2C_Write(uint8_t Addr, uint8_t Reg, uint8_t Value)
{
  FT6336_DEBUG_PRINT("FT6336: Write Addr=0x%02X Reg=0x%02X Val=0x%02X\r\n", Addr, Reg, Value);
  HAL_I2C_Mem_Write(&hi2c2, Addr << 1, Reg, I2C_MEMADD_SIZE_8BIT, &Value, 1, FT6336_I2C_TIMEOUT);
}
/**
  * @brief  Read a value from a register via I2C
  */
static uint8_t FT6336_I2C_Read(uint8_t Addr, uint8_t Reg)
{
  uint8_t value = 0;
  HAL_I2C_Mem_Read(&hi2c2, Addr << 1, Reg, I2C_MEMADD_SIZE_8BIT, &value, 1, FT6336_I2C_TIMEOUT);
  FT6336_DEBUG_PRINT("FT6336: Read Addr=0x%02X Reg=0x%02X Val=0x%02X\r\n", Addr, Reg, value);
  return value;
}

/**
  * @brief  Read multiple bytes from registers via I2C
  */
static void FT6336_I2C_ReadMultiple(uint8_t Addr, uint8_t Reg, uint8_t *Buffer, uint16_t Length)
{
  HAL_I2C_Mem_Read(&hi2c2, Addr << 1, Reg, I2C_MEMADD_SIZE_8BIT, Buffer, Length, FT6336_I2C_TIMEOUT);
}

/**
  * @brief  Initialize the hardware reset pin (PB15)
  * @note   Call this before ft6336_Init()
  */
void ft6336_InitResetPin(void)
{
  GPIO_InitTypeDef GPIO_InitStruct = {0};
  
  /* Enable GPIOB clock if not already enabled */
  __HAL_RCC_GPIOB_CLK_ENABLE();
  
  /* Configure PB15 as output */
  GPIO_InitStruct.Pin = FT6336_RST_PIN;
  GPIO_InitStruct.Mode = GPIO_MODE_OUTPUT_PP;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
  HAL_GPIO_Init(FT6336_RST_PORT, &GPIO_InitStruct);
  
  /* Set reset high (inactive) */
  HAL_GPIO_WritePin(FT6336_RST_PORT, FT6336_RST_PIN, GPIO_PIN_SET);
  
  FT6336_DEBUG_PRINT("FT6336: Reset pin (PB15) initialized\r\n");
}

/**
  * @brief  Initialize the FT6336 touch screen controller
  * @param  DeviceAddr: Device address on I2C bus (not used, hardcoded address)
  * @note   I2C peripheral must be initialized by STM32CubeMX before calling this
  * @note   Call ft6336_InitResetPin() before calling this function
  * @retval 0 on success, 1 on failure
  */
void ft6336_Init(uint16_t DeviceAddr)
{
  uint8_t temp[2];
  
  FT6336_DEBUG_PRINT("FT6336: Init start\r\n");
  (void) DeviceAddr;
  
  /* Perform hardware reset */
  FT6336_DEBUG_PRINT("FT6336: Performing hardware reset\r\n");
  HAL_GPIO_WritePin(FT6336_RST_PORT, FT6336_RST_PIN, GPIO_PIN_RESET);
  HAL_Delay(10);
  HAL_GPIO_WritePin(FT6336_RST_PORT, FT6336_RST_PIN, GPIO_PIN_SET);
  HAL_Delay(500);
  FT6336_DEBUG_PRINT("FT6336: Hardware reset complete\r\n");
  
  /* Verify FOCALTECH ID */
  temp[0] = FT6336_I2C_Read(FT6336_I2C_ADDRESS, FT6336_REG_FOCALTECH_ID);
  if(temp[0] != FT6336_FOCALTECH_ID)
  {
    FT6336_DEBUG_PRINT("FT6336: FOCALTECH_ID mismatch! Expected 0x%02X, got 0x%02X\r\n", 
                       FT6336_FOCALTECH_ID, temp[0]);
    return;
  }
  FT6336_DEBUG_PRINT("FT6336: FOCALTECH_ID verified: 0x%02X\r\n", temp[0]);
  
  /* Verify CIPHER_MID and CIPHER_LOW */
  FT6336_I2C_ReadMultiple(FT6336_I2C_ADDRESS, FT6336_REG_CIPHER_MID, temp, 2);
  if(temp[0] != FT6336_CIPHER_MID)
  {
    FT6336_DEBUG_PRINT("FT6336: CIPHER_MID mismatch! Expected 0x%02X, got 0x%02X\r\n", 
                       FT6336_CIPHER_MID, temp[0]);
    return;
  }
  if((temp[1] != 0x00) && (temp[1] != 0x01) && (temp[1] != 0x02))
  {
    FT6336_DEBUG_PRINT("FT6336: CIPHER_LOW invalid! Got 0x%02X (expected 0x00/0x01/0x02)\r\n", temp[1]);
    return;
  }
  FT6336_DEBUG_PRINT("FT6336: CIPHER verified: MID=0x%02X, LOW=0x%02X\r\n", temp[0], temp[1]);
  
  /* Verify Chip ID */
  temp[0] = FT6336_I2C_Read(FT6336_I2C_ADDRESS, FT6336_REG_CHIPID);
  if(temp[0] != FT6336_CHIPID)
  {
    FT6336_DEBUG_PRINT("FT6336: CHIPID mismatch! Expected 0x%02X, got 0x%02X\r\n", 
                       FT6336_CHIPID, temp[0]);
    return;
  }
  FT6336_DEBUG_PRINT("FT6336: CHIPID verified: 0x%02X\r\n", temp[0]);
  
  /* Configure device */
  FT6336_I2C_Write(FT6336_I2C_ADDRESS, FT6336_REG_DEV_MODE, 0x00);
  FT6336_I2C_Write(FT6336_I2C_ADDRESS, FT6336_REG_CTRL, 0x00);
  FT6336_I2C_Write(FT6336_I2C_ADDRESS, FT6336_REG_TIMEENTERMONITOR, 0x0A);
  FT6336_I2C_Write(FT6336_I2C_ADDRESS, FT6336_REG_PERIODACTIVE, 0x0C);
  FT6336_I2C_Write(FT6336_I2C_ADDRESS, FT6336_REG_PERIODMONITOR, 0x28);
  
  FT6336_DEBUG_PRINT("FT6336: Init complete - performing initial scan\r\n");
  
  /* Perform initial scan to test functionality */
  if(ft6336_Scan(0))
  {
    FT6336_DEBUG_PRINT("FT6336: Initial scan detected touch\r\n");
  }
  else
  {
    FT6336_DEBUG_PRINT("FT6336: Initial scan - no touch detected\r\n");
  }
}

/**
  * @brief  Read the FT6336 chip ID
  * @param  DeviceAddr: Device address on I2C bus
  * @retval The chip ID (should be 0x64 for FT6336)
  */
uint16_t ft6336_ReadID(uint16_t DeviceAddr)
{
  (void) DeviceAddr;
  uint8_t chipid;
  
  chipid = FT6336_I2C_Read(FT6336_I2C_ADDRESS, FT6336_REG_CHIPID);
  FT6336_DEBUG_PRINT("FT6336: Chip ID = 0x%02X\r\n", chipid);
  
  return (uint16_t)chipid;
}

/**
  * @brief  Reset the FT6336
  * @param  DeviceAddr: Device address on I2C bus
  */
void ft6336_Reset(uint16_t DeviceAddr)
{
  (void) DeviceAddr;
  /* Software reset */
  FT6336_I2C_Write(FT6336_I2C_ADDRESS, FT6336_REG_DEV_MODE, 0x00);
  HAL_Delay(200);
}

/**
  * @brief  Start the FT6336
  * @param  DeviceAddr: Device address on I2C bus
  */
void ft6336_Start(uint16_t DeviceAddr)
{
  (void) DeviceAddr;
  /* Nothing specific needed for FT6336 */
}

/**
  * @brief  Detect touch
  * @param  DeviceAddr: Device address on I2C bus
  * @retval Number of touches detected (0, 1, or 2)
  */
uint8_t ft6336_DetectTouch(uint16_t DeviceAddr)
{
  (void) DeviceAddr;
  uint8_t nb_touch;
  
  nb_touch = FT6336_I2C_Read(FT6336_I2C_ADDRESS, FT6336_REG_TD_STATUS);
  nb_touch &= 0x0F;
  FT6336_DEBUG_PRINT("FT6336: Touches detected = %d\r\n", nb_touch);
  
  return (nb_touch > 0) ? 1 : 0;
}

/**
  * @brief  Get the touch coordinates
  * @param  DeviceAddr: Device address on I2C bus
  * @param  X: Pointer to X coordinate
  * @param  Y: Pointer to Y coordinate
  */
void ft6336_GetXY(uint16_t DeviceAddr, uint16_t *X, uint16_t *Y)
{
  (void) DeviceAddr;
  uint8_t data[4];
  
  FT6336_I2C_ReadMultiple(FT6336_I2C_ADDRESS, FT6336_REG_P1_XH, data, 4);
  
  *X = ((data[0] & 0x0F) << 8) | data[1];
  *Y = ((data[2] & 0x0F) << 8) | data[3];
  FT6336_DEBUG_PRINT("FT6336: X=%d Y=%d\r\n", *X, *Y);
}

/**
  * @brief  Enable interrupt
  * @param  DeviceAddr: Device address on I2C bus
  */
void ft6336_EnableIT(uint16_t DeviceAddr)
{
  (void) DeviceAddr;
  /* Configure interrupt mode */
  FT6336_I2C_Write(FT6336_I2C_ADDRESS, FT6336_REG_CTRL, 0x01);
}

/**
  * @brief  Clear interrupt
  * @param  DeviceAddr: Device address on I2C bus
  */
void ft6336_ClearIT(uint16_t DeviceAddr)
{
  (void) DeviceAddr;
  /* Read status to clear interrupt */
  FT6336_I2C_Read(FT6336_I2C_ADDRESS, FT6336_REG_TD_STATUS);
}

/**
  * @brief  Get interrupt status
  * @param  DeviceAddr: Device address on I2C bus
  * @retval Interrupt status
  */
uint8_t ft6336_GetITStatus(uint16_t DeviceAddr)
{
  /* Check if touch is detected */
  return ft6336_DetectTouch(DeviceAddr);
}

/**
  * @brief  Disable interrupt
  * @param  DeviceAddr: Device address on I2C bus
  */
void ft6336_DisableIT(uint16_t DeviceAddr)
{
  (void) DeviceAddr;
  /* Configure polling mode */
  FT6336_I2C_Write(FT6336_I2C_ADDRESS, FT6336_REG_CTRL, 0x00);
}

/**
  * @brief  Scan for touch events
  * @param  DeviceAddr: Device address on I2C bus
  * @retval 1 if touch detected, 0 if no touch
  */
uint8_t ft6336_Scan(uint16_t DeviceAddr)
{
  (void) DeviceAddr;
  uint8_t mode;
  uint8_t data[4];
  uint16_t x, y;
  
  /* Read touch status */
  mode = FT6336_I2C_Read(FT6336_I2C_ADDRESS, FT6336_REG_TD_STATUS);
  mode &= 0x0F;
  
  FT6336_DEBUG_PRINT("FT6336: Scan - Touch points: %d\r\n", mode);
  
  if(mode > 0 && mode < 3)
  {
    /* Read first touch point */
    FT6336_I2C_ReadMultiple(FT6336_I2C_ADDRESS, FT6336_REG_P1_XH, data, 4);
    
    x = ((data[0] & 0x0F) << 8) | data[1];
    y = ((data[2] & 0x0F) << 8) | data[3];
    
    FT6336_DEBUG_PRINT("FT6336: Touch 1 - X=%d, Y=%d\r\n", x, y);
    
    /* If two touches detected */
    if(mode == 2)
    {
      FT6336_I2C_ReadMultiple(FT6336_I2C_ADDRESS, FT6336_REG_P2_XH, data, 4);
      
      x = ((data[0] & 0x0F) << 8) | data[1];
      y = ((data[2] & 0x0F) << 8) | data[3];
      
      FT6336_DEBUG_PRINT("FT6336: Touch 2 - X=%d, Y=%d\r\n", x, y);
    }
    
    return 1;
  }
  
  return 0;
}